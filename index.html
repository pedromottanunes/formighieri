<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FormGuiare • Upload de Projeto</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- pdf-lib (merge PDFs) -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <!-- Dropbox SDK -->
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>

  <style>
    :root {
      --fg-primary: #0f766e;
      --fg-primary-light: #14b8a6;
    }
    .bg-gradient-primary {
      background: linear-gradient(135deg, var(--fg-primary) 0%, var(--fg-primary-light) 100%);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-teal-50 py-10 px-4">
  <!-- Container -->
  <div class="relative max-w-3xl mx-auto">
    <header class="text-center mb-10 animate-fade-in-up">
      <h1 class="text-4xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent flex items-center justify-center gap-3">
        <img src="https://www.dropbox.com/scl/fi/1lcom3fqzeltyx32h1jya/logood.png?rlkey=ko8p8yvfwjhxndelr8u6tzibz&st=8yqcsrq9&dl=1" alt="FormGuiare" class="w-12 h-6" />
        Upload de Projeto
      </h1>
      <p class="text-gray-600 mt-2">Preencha os dados do cabeçalho e envie os arquivos XML e PDF do seu pedido.</p>
    </header>

    <!-- Card -->
    <main class="bg-white bg-opacity-90 backdrop-blur-md rounded-3xl shadow-2xl p-8 animate-fade-in-up animate-delay-100">
      <form id="fgForm" class="space-y-10">
        <!-- Cabeçalho -->
        <section>
          <h2 class="flex items-center gap-2 text-xl font-semibold text-gray-800 mb-6">
            <i data-lucide="user" class="w-5 h-5 text-teal-600"></i>
            Dados do Cliente
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="nome">Nome</label>
              <input id="nome" name="nome" type="text" required placeholder="Nome completo" class="w-full h-12 px-4 rounded-xl border-2 border-gray-200 focus:border-emerald-400 focus:outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="cpf">CPF</label>
              <input id="cpf" name="cpf" type="text" required placeholder="000.000.000-00" class="w-full h-12 px-4 rounded-xl border-2 border-gray-200 focus:border-emerald-400 focus:outline-none" />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="endereco">Endereço</label>
              <input id="endereco" name="endereco" type="text" required placeholder="Rua, número" class="w-full h-12 px-4 rounded-xl border-2 border-gray-200 focus:border-emerald-400 focus:outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="cep">CEP</label>
              <input id="cep" name="cep" type="text" required placeholder="00000-000" class="w-full h-12 px-4 rounded-xl border-2 border-gray-200 focus:border-emerald-400 focus:outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="cidade">Cidade</label>
              <input id="cidade" name="cidade" type="text" required placeholder="Cidade" class="w-full h-12 px-4 rounded-xl border-2 border-gray-200 focus:border-emerald-400 focus:outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="estado">Estado</label>
              <input id="estado" name="estado" type="text" required placeholder="UF" maxlength="2" class="w-full h-12 px-4 rounded-xl border-2 border-gray-200 focus:border-emerald-400 focus:outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="telefone">Telefone</label>
              <input id="telefone" name="telefone" type="text" required placeholder="(00) 00000-0000" class="w-full h-12 px-4 rounded-xl border-2 border-gray-200 focus:border-emerald-400 focus:outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="email">E‑mail</label>
              <input id="email" name="email" type="email" required placeholder="usuario@exemplo.com" class="w-full h-12 px-4 rounded-xl border-2 border-gray-200 focus:border-emerald-400 focus:outline-none" />
            </div>
          </div>
        </section>

        <!-- Uploads -->
        <section>
          <h2 class="flex items-center gap-2 text-xl font-semibold text-gray-800 mb-6">
            <i data-lucide="upload-cloud" class="w-5 h-5 text-teal-600"></i>
            Envio de Arquivos
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- XML -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo XML</label>
              <label class="flex items-center justify-center w-full h-32 rounded-xl border-2 border-dashed border-gray-300 cursor-pointer hover:border-emerald-400 transition" id="xmlDrop">
                <span class="text-gray-500" id="xmlLabel">Clique ou arraste o XML aqui</span>
                <input type="file" id="xmlInput" accept=".xml" class="hidden" required />
              </label>
            </div>
            <!-- PDFs -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Arquivos PDF (1+)</label>
              <label class="flex items-center justify-center w-full h-32 rounded-xl border-2 border-dashed border-gray-300 cursor-pointer hover:border-emerald-400 transition" id="pdfDrop">
                <span class="text-gray-500" id="pdfLabel">Clique ou arraste PDFs aqui</span>
                <input type="file" id="pdfInput" accept="application/pdf" multiple class="hidden" required />
              </label>
              <ul id="pdfList" class="mt-2 space-y-1 text-sm text-gray-600"></ul>
            </div>
          </div>
        </section>

        <!-- Submit -->
        <div class="flex justify-center">
          <button type="submit" class="w-full md:w-auto px-8 h-14 bg-gradient-primary text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 hover:opacity-90 transition">
            <i data-lucide="send" class="w-5 h-5"></i>
            Enviar Dados
          </button>
        </div>
        <p id="msg" class="text-center text-sm hidden"></p>
      </form>
    </main>

    <footer class="mt-10 text-center text-gray-500 text-sm">
      © 2025 FormGuiare. Powered by Fulljob.com.br.
    </footer>
  </div>

  <script>
    // ===== Configurações =====
    const CONFIG = {
      WEBHOOK_URL: "https://hook.exemplo.com/webhook", // <<< Substitua
      DROPBOX_TOKEN: "YOUR_DROPBOX_ACCESS_TOKEN", // <<< Substitua
      DROPBOX_XML_PATH: "/xml/",
      DROPBOX_PDF_PATH: "/pdfs/",
    };

    // ===== Utilidades =====
    const showMsg = (text, ok = true) => {
      const el = document.getElementById("msg");
      el.textContent = text;
      el.className = ok ? "text-center text-sm text-green-600" : "text-center text-sm text-red-600";
      el.classList.remove("hidden");
    };

    const dbx = new Dropbox.Dropbox({ accessToken: CONFIG.DROPBOX_TOKEN, fetch });

    // ===== Upload Handlers =====
    const xmlInput = document.getElementById("xmlInput");
    const pdfInput = document.getElementById("pdfInput");

    document.getElementById("xmlDrop").addEventListener("click", () => xmlInput.click());
    document.getElementById("pdfDrop").addEventListener("click", () => pdfInput.click());

    // Preview PDFs list
    pdfInput.addEventListener("change", () => {
      const list = document.getElementById("pdfList");
      list.innerHTML = Array.from(pdfInput.files).map(f => `<li>• ${f.name}</li>`).join("");
      document.getElementById("pdfLabel").textContent = pdfInput.files.length ? `${pdfInput.files.length} PDF(s) selecionado(s)` : "Clique ou arraste PDFs aqui";
    });

    xmlInput.addEventListener("change", () => {
      document.getElementById("xmlLabel").textContent = xmlInput.files.length ? xmlInput.files[0].name : "Clique ou arraste o XML aqui";
    });

    // ===== Form Submit =====
    document.getElementById("fgForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      showMsg("Processando…", true);

      try {
        // 1. Upload XML
        const xmlFile = xmlInput.files[0];
        const xmlUpload = await dbx.filesUpload({
          path: `${CONFIG.DROPBOX_XML_PATH}${Date.now()}_${xmlFile.name}`,
          contents: xmlFile,
        });

        // 2. Preparar (e possivelmente mesclar) PDFs
        let finalPdfBlob;
        if (pdfInput.files.length === 1) {
          finalPdfBlob = pdfInput.files[0];
        } else {
          const mergedPdf = await PDFLib.PDFDocument.create();
          for (const file of pdfInput.files) {
            const bytes = await file.arrayBuffer();
            const pdf = await PDFLib.PDFDocument.load(bytes);
            const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
            copiedPages.forEach((p) => mergedPdf.addPage(p));
          }
          const mergedBytes = await mergedPdf.save();
          finalPdfBlob = new Blob([mergedBytes], { type: "application/pdf" });
        }

        // 3. Upload PDF (único ou mesclado)
        const pdfUpload = await dbx.filesUpload({
          path: `${CONFIG.DROPBOX_PDF_PATH}${Date.now()}_projeto.pdf`,
          contents: finalPdfBlob,
        });

        // 4. Construir payload do webhook
        const formData = new FormData(e.target);
        const payload = Object.fromEntries(formData.entries());
        payload.xml_file_id = xmlUpload.result ? xmlUpload.result.id : xmlUpload.id;
        payload.pdf_file_id = pdfUpload.result ? pdfUpload.result.id : pdfUpload.id;

        // 5. Enviar webhook
        await fetch(CONFIG.WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        showMsg("✅ Arquivos enviados com sucesso!");
        e.target.reset();
        document.getElementById("pdfList").innerHTML = "";
        document.getElementById("pdfLabel").textContent = "Clique ou arraste PDFs aqui";
        document.getElementById("xmlLabel").textContent = "Clique ou arraste o XML aqui";
      } catch (err) {
        console.error(err);
        showMsg(`❌ Erro: ${err.message}`, false);
      }
    });

    // Init icons
    document.addEventListener("DOMContentLoaded", () => lucide.createIcons());
  </script>
</body>
</html>
